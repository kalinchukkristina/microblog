- name: Installing Prometheus, Grafana, Alertmanager
  hosts: monitoring
  remote_user: deploy
  become: true
  roles:
    - docker-installation
  tasks:
    - name: Create a network for Monitoring
      docker_network:
        name: monitoring_network
        state: present

    - name: Create directory for Prometheus data and configuration
      file:
        path: /prometheus
        state: directory

    - name: Copy Prometheus configuration file to the server
      copy:
        src: prometheus.yml  # Update with the actual path to your prometheus.yml file
        dest: /prometheus/prometheus.yml
        mode: 0644

    - name: Start Prometheus container
      docker_container:
        name: prometheus
        image: prom/prometheus
        volumes:
          - /prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
        command:
          - "--config.file=/etc/prometheus/prometheus.yml"
          - "--storage.tsdb.path=/prometheus"
          - "--web.console.libraries=/etc/prometheus/console_libraries"
          - "--web.console.templates=/etc/prometheus/consoles"
          - "--storage.tsdb.retention.time=24h"
          - "--web.enable-lifecycle"
        ports:
          - "9090:9090"
        networks:
          - name: monitoring_network
        restart_policy: always
        state: started

    - name: Start Grafana container
      docker_container:
        name: grafana
        image: grafana/grafana
        ports:
          - "3000:3000"
        networks:
          - name: monitoring_network
        restart_policy: always
        state: started

    - name: Start Alertmanager container
      docker_container:
        name: alertmanager
        image: prom/alertmanager
        ports:
          - "9093:9093"
        networks:
          - name: monitoring_network
        restart_policy: always
        state: started

    - name: Prometheus as data source
      community.grafana.grafana_datasource:
        name: prometheus
        url: http://{{ groups["monitoring"][0] }}:3000
        ds_type: prometheus
        ds_url: http://{{ groups["monitoring"][0] }}:9090
        url_username : admin
        url_password: admin